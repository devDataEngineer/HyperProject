# import pandas as pd
from src.transformlambda.json_to_panda_func import json_to_panda_df
from src.transformlambda.convert_df_to_pq_bytes import convert_dataframe_to_parquet_bytes
from src.transformlambda.get_data import get_data_from_ingestion_bucket
from src.transformlambda.upload_to_processed_bucket import upload_to_processed_bucket
# from io import BytesIO
import pytest
import boto3
from moto import mock_aws
import os

BUCKET1 = "team-hyper-accelerated-dragon-bucket-processed"
KEY = "TEST_KEY"
CONTENT = '''[{"id":1,"first_name":"Reinaldo","last_name":"Pinchbeck","email":"rpinchbeck0@alexa.com","gender":"Male","ip_address":"237.188.238.35"},
{"id":2,"first_name":"Joshuah","last_name":"Reyes","email":"jreyes1@taobao.com","gender":"Male","ip_address":"242.77.75.252"}]'''

parquet_bytes = b'PAR1\x15\x04\x15 \x15$L\x15\x04\x15\x00\x12\x00\x00\x10<\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c\x18\x08\x02\x00\x00\x00\x00\x00\x00\x00\x18\x08\x01\x00\x00\x00\x00\x00\x00\x00\x16\x00(\x08\x02\x00\x00\x00\x00\x00\x00\x00\x18\x08\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x03\x02&\xd8\x01\x1c\x15\x04\x195\x00\x06\x10\x19\x18\x02id\x15\x02\x16\x04\x16\xc8\x01\x16\xd0\x01&H&\x08\x1c\x18\x08\x02\x00\x00\x00\x00\x00\x00\x00\x18\x08\x01\x00\x00\x00\x00\x00\x00\x00\x16\x00(\x08\x02\x00\x00\x00\x00\x00\x00\x00\x18\x08\x01\x00\x00\x00\x00\x00\x00\x00\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x15\x04\x15.\x152L\x15\x04\x15\x00\x12\x00\x00\x17X\x08\x00\x00\x00Reinaldo\x07\x00\x00\x00Joshuah\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c6\x00(\x08Reinaldo\x18\x07Joshuah\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x03\x02&\xc4\x04\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\nfirst_name\x15\x02\x16\x04\x16\xac\x01\x16\xb4\x01&\xde\x03&\x90\x03\x1c6\x00(\x08Reinaldo\x18\x07Joshuah\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x15\x04\x15,\x150L\x15\x04\x15\x00\x12\x00\x00\x16T\t\x00\x00\x00Pinchbeck\x05\x00\x00\x00Reyes\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c6\x00(\x05Reyes\x18\tPinchbeck\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x03\x02&\x96\x07\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\tlast_name\x15\x02\x16\x04\x16\xa8\x01\x16\xb0\x01&\xb2\x06&\xe6\x05\x1c6\x00(\x05Reyes\x18\tPinchbeck\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x15\x04\x15^\x15bL\x15\x04\x15\x00\x12\x00\x00/\xb8\x15\x00\x00\x00rpinchbeck0@alexa.com\x12\x00\x00\x00jreyes1@taobao.com\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c6\x00(\x15rpinchbeck0@alexa.com\x18\x12jreyes1@taobao.com\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x03\x02&\xc8\n\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\x05email\x15\x02\x16\x04\x16\x8c\x02\x16\x94\x02&\xb2\t&\xb4\x08\x1c6\x00(\x15rpinchbeck0@alexa.com\x18\x12jreyes1@taobao.com\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x15\x04\x15\x10\x15\x14L\x15\x02\x15\x00\x12\x00\x00\x08\x1c\x04\x00\x00\x00Male\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c6\x00(\x04Male\x18\x04Male\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x04\x00&\x98\r\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\x06gender\x15\x02\x16\x04\x16\x80\x01\x16\x88\x01&\xc0\x0c&\x90\x0c\x1c6\x00(\x04Male\x18\x04Male\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x15\x04\x15F\x15HL\x15\x04\x15\x00\x12\x00\x00#H\x0e\x00\x00\x00237.188.238.35\r\x01\x12,42.77.75.252\x15\x00\x15\x12\x15\x16,\x15\x04\x15\x10\x15\x06\x15\x06\x1c6\x00(\r242.77.75.252\x18\x0e237.188.238.35\x00\x00\x00\t \x02\x00\x00\x00\x04\x01\x01\x03\x02&\x86\x10\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\nip_address\x15\x02\x16\x04\x16\xdc\x01\x16\xe2\x01&\x88\x0f&\xa4\x0e\x1c6\x00(\r242.77.75.252\x18\x0e237.188.238.35\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x15\x04\x19|5\x00\x18\x06schema\x15\x0c\x00\x15\x04%\x02\x18\x02id\x00\x15\x0c%\x02\x18\nfirst_name%\x00L\x1c\x00\x00\x00\x15\x0c%\x02\x18\tlast_name%\x00L\x1c\x00\x00\x00\x15\x0c%\x02\x18\x05email%\x00L\x1c\x00\x00\x00\x15\x0c%\x02\x18\x06gender%\x00L\x1c\x00\x00\x00\x15\x0c%\x02\x18\nip_address%\x00L\x1c\x00\x00\x00\x16\x04\x19\x1c\x19l&\xd8\x01\x1c\x15\x04\x195\x00\x06\x10\x19\x18\x02id\x15\x02\x16\x04\x16\xc8\x01\x16\xd0\x01&H&\x08\x1c\x18\x08\x02\x00\x00\x00\x00\x00\x00\x00\x18\x08\x01\x00\x00\x00\x00\x00\x00\x00\x16\x00(\x08\x02\x00\x00\x00\x00\x00\x00\x00\x18\x08\x01\x00\x00\x00\x00\x00\x00\x00\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00&\xc4\x04\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\nfirst_name\x15\x02\x16\x04\x16\xac\x01\x16\xb4\x01&\xde\x03&\x90\x03\x1c6\x00(\x08Reinaldo\x18\x07Joshuah\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00&\x96\x07\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\tlast_name\x15\x02\x16\x04\x16\xa8\x01\x16\xb0\x01&\xb2\x06&\xe6\x05\x1c6\x00(\x05Reyes\x18\tPinchbeck\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00&\xc8\n\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\x05email\x15\x02\x16\x04\x16\x8c\x02\x16\x94\x02&\xb2\t&\xb4\x08\x1c6\x00(\x15rpinchbeck0@alexa.com\x18\x12jreyes1@taobao.com\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00&\x98\r\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\x06gender\x15\x02\x16\x04\x16\x80\x01\x16\x88\x01&\xc0\x0c&\x90\x0c\x1c6\x00(\x04Male\x18\x04Male\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00&\x86\x10\x1c\x15\x0c\x195\x00\x06\x10\x19\x18\nip_address\x15\x02\x16\x04\x16\xdc\x01\x16\xe2\x01&\x88\x0f&\xa4\x0e\x1c6\x00(\r242.77.75.252\x18\x0e237.188.238.35\x00\x19,\x15\x04\x15\x00\x15\x02\x00\x15\x00\x15\x10\x15\x02\x00\x00\x00\x16\x84\t\x16\x04&\x08\x16\xb2\t\x14\x00\x00\x19,\x18\x06pandas\x18\xec\x07{"index_columns": [{"kind": "range", "name": null, "start": 0, "stop": 2, "step": 1}], "column_indexes": [{"name": null, "field_name": null, "pandas_type": "unicode", "numpy_type": "object", "metadata": {"encoding": "UTF-8"}}], "columns": [{"name": "id", "field_name": "id", "pandas_type": "int64", "numpy_type": "int64", "metadata": null}, {"name": "first_name", "field_name": "first_name", "pandas_type": "unicode", "numpy_type": "object", "metadata": null}, {"name": "last_name", "field_name": "last_name", "pandas_type": "unicode", "numpy_type": "object", "metadata": null}, {"name": "email", "field_name": "email", "pandas_type": "unicode", "numpy_type": "object", "metadata": null}, {"name": "gender", "field_name": "gender", "pandas_type": "unicode", "numpy_type": "object", "metadata": null}, {"name": "ip_address", "field_name": "ip_address", "pandas_type": "unicode", "numpy_type": "object", "metadata": null}], "creator": {"library": "pyarrow", "version": "17.0.0"}, "pandas_version": "2.2.2"}\x00\x18\x0cARROW:schema\x18\xec\x0e/////4gFAAAQAAAAAAAKAA4ABgAFAAgACgAAAAABBAAQAAAAAAAKAAwAAAAEAAgACgAAACQEAAAEAAAAAQAAAAwAAAAIAAwABAAIAAgAAAD8AwAABAAAAOwDAAB7ImluZGV4X2NvbHVtbnMiOiBbeyJraW5kIjogInJhbmdlIiwgIm5hbWUiOiBudWxsLCAic3RhcnQiOiAwLCAic3RvcCI6IDIsICJzdGVwIjogMX1dLCAiY29sdW1uX2luZGV4ZXMiOiBbeyJuYW1lIjogbnVsbCwgImZpZWxkX25hbWUiOiBudWxsLCAicGFuZGFzX3R5cGUiOiAidW5pY29kZSIsICJudW1weV90eXBlIjogIm9iamVjdCIsICJtZXRhZGF0YSI6IHsiZW5jb2RpbmciOiAiVVRGLTgifX1dLCAiY29sdW1ucyI6IFt7Im5hbWUiOiAiaWQiLCAiZmllbGRfbmFtZSI6ICJpZCIsICJwYW5kYXNfdHlwZSI6ICJpbnQ2NCIsICJudW1weV90eXBlIjogImludDY0IiwgIm1ldGFkYXRhIjogbnVsbH0sIHsibmFtZSI6ICJmaXJzdF9uYW1lIiwgImZpZWxkX25hbWUiOiAiZmlyc3RfbmFtZSIsICJwYW5kYXNfdHlwZSI6ICJ1bmljb2RlIiwgIm51bXB5X3R5cGUiOiAib2JqZWN0IiwgIm1ldGFkYXRhIjogbnVsbH0sIHsibmFtZSI6ICJsYXN0X25hbWUiLCAiZmllbGRfbmFtZSI6ICJsYXN0X25hbWUiLCAicGFuZGFzX3R5cGUiOiAidW5pY29kZSIsICJudW1weV90eXBlIjogIm9iamVjdCIsICJtZXRhZGF0YSI6IG51bGx9LCB7Im5hbWUiOiAiZW1haWwiLCAiZmllbGRfbmFtZSI6ICJlbWFpbCIsICJwYW5kYXNfdHlwZSI6ICJ1bmljb2RlIiwgIm51bXB5X3R5cGUiOiAib2JqZWN0IiwgIm1ldGFkYXRhIjogbnVsbH0sIHsibmFtZSI6ICJnZW5kZXIiLCAiZmllbGRfbmFtZSI6ICJnZW5kZXIiLCAicGFuZGFzX3R5cGUiOiAidW5pY29kZSIsICJudW1weV90eXBlIjogIm9iamVjdCIsICJtZXRhZGF0YSI6IG51bGx9LCB7Im5hbWUiOiAiaXBfYWRkcmVzcyIsICJmaWVsZF9uYW1lIjogImlwX2FkZHJlc3MiLCAicGFuZGFzX3R5cGUiOiAidW5pY29kZSIsICJudW1weV90eXBlIjogIm9iamVjdCIsICJtZXRhZGF0YSI6IG51bGx9XSwgImNyZWF0b3IiOiB7ImxpYnJhcnkiOiAicHlhcnJvdyIsICJ2ZXJzaW9uIjogIjE3LjAuMCJ9LCAicGFuZGFzX3ZlcnNpb24iOiAiMi4yLjIifQAAAAAGAAAAcGFuZGFzAAAGAAAAAAEAALwAAACMAAAAYAAAADQAAAAEAAAAKP///wAAAQUQAAAAHAAAAAQAAAAAAAAACgAAAGlwX2FkZHJlc3MAAFj///9U////AAABBRAAAAAYAAAABAAAAAAAAAAGAAAAZ2VuZGVyAACA////fP///wAAAQUQAAAAGAAAAAQAAAAAAAAABQAAAGVtYWlsAAAAqP///6T///8AAAEFEAAAABwAAAAEAAAAAAAAAAkAAABsYXN0X25hbWUAAADU////0P///wAAAQUQAAAAIAAAAAQAAAAAAAAACgAAAGZpcnN0X25hbWUAAAQABAAEAAAAEAAUAAgABgAHAAwAAAAQABAAAAAAAAECEAAAABwAAAAEAAAAAAAAAAIAAABpZAAACAAMAAgABwAIAAAAAAAAAUAAAAA=\x00\x18 parquet-cpp-arrow version 17.0.0\x19l\x1c\x00\x00\x1c\x00\x00\x1c\x00\x00\x1c\x00\x00\x1c\x00\x00\x1c\x00\x00\x00H\x0e\x00\x00PAR1'


@pytest.fixture
def aws_creds():
    os.environ["AWS_ACCESS_KEY_ID"] = "test"
    os.environ["AWS_SECRET_ACCESS_KEY"] = "test"
    os.environ["AWS_SECURITY_TOKEN"] = "test"
    os.environ["AWS_SESSION_TOKEN"] = "test"
    os.environ["AWS_DEFAULT_REGION"] = "eu-west-2"

@pytest.fixture
def s3_client(aws_creds):
    with mock_aws():
        s3_client = boto3.client("s3")
        s3_client.create_bucket(Bucket=BUCKET1, CreateBucketConfiguration={'LocationConstraint': 'eu-west-2'})
        yield s3_client

@pytest.fixture
def resource_client(aws_cred):
    with mock_aws():
        s3_resource = boto3.resource("s3")


def test_upload_bytes_to_bucket(s3_client): 
    bucket_response = upload_to_processed_bucket(parquet_bytes,"test file 42")
    object_from_bucket = s3_client.get_object(Bucket=BUCKET1,Key="test file 42")
    assert object_from_bucket['Body'].read() == parquet_bytes
    assert isinstance(object_from_bucket['Body'].read(), bytes)




